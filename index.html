<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dome Album</title>
    <meta name="theme-color" content="#060010">
    <meta name="description" content="Immersive 3D Dome Gallery">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ€</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="app-manifest" crossorigin="use-credentials">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: white;
        }

        /* Installation Dialog */
        #install-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #install-dialog.show {
            display: flex;
            opacity: 1;
        }

        .install-content {
            background: rgba(20, 20, 30, 0.95);
            padding: 2rem;
            border-radius: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        #install-dialog.show .install-content {
            transform: translateY(0);
        }

        .install-content h2 {
            margin-bottom: 1rem;
            color: white;
            font-weight: 600;
        }

        .install-content p {
            margin-bottom: 2rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .install-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .install-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        #confirm-install {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #confirm-install:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        #cancel-install {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        #cancel-install:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Logo */
        #app-logo {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            z-index: 100;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            user-select: none;
            transition: transform 0.2s ease;
        }

        #app-logo:hover {
            transform: scale(1.05);
        }

        #app-logo:active {
            transform: scale(0.95);
        }

        /* Landscape Warning */
        #landscape-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #060010;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 2rem;
        }

        #landscape-warning.show {
            display: flex;
        }

        .warning-content {
            max-width: 400px;
        }

        .warning-content h2 {
            margin-bottom: 1rem;
            color: white;
        }

        .warning-content p {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 2rem;
        }

        .rotate-icon {
            font-size: 48px;
            margin-bottom: 1rem;
            animation: rotate 2s infinite linear;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(90deg); }
        }

        /* Dome Gallery Styles */
        .sphere-root {
            position: relative;
            width: 100%;
            height: 100%;
            --radius: 520px;
            --viewer-pad: 72px;
            --circ: calc(var(--radius) * 3.14159265359);
            --rot-y: calc((360deg / var(--segments-x)) / 2);
            --rot-x: calc((360deg / var(--segments-y)) / 2);
            --item-width: calc(var(--circ) / var(--segments-x));
            --item-height: calc(var(--circ) / var(--segments-y));
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }

        .sphere-root * {
            box-sizing: border-box;
        }

        main.sphere-main {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            background: transparent;
            transform-style: preserve-3d;
        }

        .stage {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center;
            perspective: calc(var(--radius) * 2);
            perspective-origin: 50% 50%;
            contain: layout paint size;
        }

        .sphere {
            transform: translateZ(calc(var(--radius) * -1)) rotateX(-90deg);
            will-change: transform;
            transform-style: preserve-3d;
        }

        .sphere,
        .item,
        .item__image {
            transform-style: preserve-3d;
        }

        .overlay,
        .overlay--blur {
            position: absolute;
            inset: 0;
            margin: auto;
            z-index: 3;
            pointer-events: none;
        }

        .overlay {
            background-image: radial-gradient(rgba(235, 235, 235, 0) 65%, var(--overlay-blur-color, #060010) 100%);
        }

        .overlay--blur {
            -webkit-mask-image: radial-gradient(rgba(235, 235, 235, 0) 70%, var(--overlay-blur-color, #060010) 90%);
            mask-image: radial-gradient(rgba(235, 235, 235, 0) 70%, var(--overlay-blur-color, #060010) 90%);
            backdrop-filter: blur(3px);
        }

        .item {
            width: calc(var(--item-width) * var(--item-size-x));
            height: calc(var(--item-height) * var(--item-size-y));
            position: absolute;
            top: -999px;
            bottom: -999px;
            left: -999px;
            right: -999px;
            margin: auto;
            transform-origin: 50% 50%;
            backface-visibility: hidden;
            transition: transform 300ms;
            transform: rotateY(calc(var(--rot-y) * (var(--offset-x) + ((var(--item-size-x) - 1) / 2)) + var(--rot-y-delta, 0deg)))
                rotateX(calc(var(--rot-x) * (var(--offset-y) - ((var(--item-size-y) - 1) / 2)) + var(--rot-x-delta, 0deg)))
                translateZ(var(--radius));
        }

        .item__image {
            position: absolute;
            display: block;
            inset: 10px;
            border-radius: var(--tile-radius, 12px);
            background: transparent;
            overflow: hidden;
            backface-visibility: hidden;
            transition: transform 300ms;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            pointer-events: auto;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        .item__image:focus {
            outline: none;
        }

        .item__image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            backface-visibility: hidden;
            filter: var(--image-filter, none);
        }

        .viewer {
            position: absolute;
            inset: 0;
            z-index: 20;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--viewer-pad);
        }

        .viewer .frame {
            height: 100%;
            aspect-ratio: 1;
            border-radius: var(--enlarge-radius, 32px);
            display: flex;
        }

        @media (max-aspect-ratio: 1/1) {
            .viewer .frame {
                height: auto;
                width: 100%;
            }
        }

        .viewer .scrim {
            position: absolute;
            inset: 0;
            z-index: 10;
            background: rgba(0, 0, 0, 0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 500ms ease;
            backdrop-filter: blur(3px);
        }

        .sphere-root[data-enlarging='true'] .viewer .scrim {
            opacity: 1;
            pointer-events: all;
        }

        .viewer .enlarge {
            position: absolute;
            z-index: 30;
            border-radius: var(--enlarge-radius, 32px);
            overflow: hidden;
            transition:
                transform 500ms ease,
                opacity 500ms ease;
            transform-origin: top left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        .viewer .enlarge img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: var(--image-filter, none);
        }

        .sphere-root .enlarge-closing img {
            filter: var(--image-filter, none);
        }

        .edge-fade {
            position: absolute;
            left: 0;
            right: 0;
            height: 120px;
            z-index: 5;
            pointer-events: none;
            background: linear-gradient(to bottom, transparent, var(--overlay-blur-color, #060010));
        }

        .edge-fade--top {
            top: 0;
            transform: rotate(180deg);
        }

        .edge-fade--bottom {
            bottom: 0;
        }

        /* Scroll lock */
        .dg-scroll-lock {
            overflow: hidden !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) and (orientation: portrait) {
            body.force-landscape {
                transform: rotate(90deg);
                transform-origin: 0 0;
                width: 100vh;
                height: 100vw;
                position: absolute;
                top: 0;
                left: 0;
                overflow: hidden;
            }
            
            body.force-landscape #app-logo {
                transform: rotate(-90deg) translateX(-20px) translateY(20px);
                transform-origin: 0 0;
            }
        }

        @media (min-width: 769px) {
            .sphere-root {
                transform: none !important;
            }
        }

        /* Hide address bar on mobile */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            main.sphere-main {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <!-- Logo -->
    <div id="app-logo" title="Double-click to install app">DA</div>
    
    <!-- Installation Dialog -->
    <div id="install-dialog">
        <div class="install-content">
            <h2>Install Dome Album</h2>
            <p>Do you want to install the app on your device? You'll be able to access it offline and get a better experience.</p>
            <div class="install-buttons">
                <button id="cancel-install" class="install-btn">Cancel</button>
                <button id="confirm-install" class="install-btn">Install</button>
            </div>
        </div>
    </div>

    <!-- Landscape Warning -->
    <div id="landscape-warning">
        <div class="warning-content">
            <div class="rotate-icon">â†»</div>
            <h2>Please Rotate Your Device</h2>
            <p>For the best experience with Dome Album, please rotate your device to landscape mode.</p>
        </div>
    </div>

    <!-- Dome Gallery Container -->
    <div class="sphere-root" id="dome-root"
        style="--segments-x: 35; --segments-y: 35; --overlay-blur-color: #060010; --tile-radius: 30px; --enlarge-radius: 30px; --image-filter: grayscale(1);">
        <main class="sphere-main" id="sphere-main">
            <div class="stage">
                <div class="sphere" id="sphere"></div>
            </div>
            <div class="overlay"></div>
            <div class="overlay overlay--blur"></div>
            <div class="edge-fade edge-fade--top"></div>
            <div class="edge-fade edge-fade--bottom"></div>
            <div class="viewer" id="viewer">
                <div class="scrim" id="scrim"></div>
                <div class="frame" id="frame"></div>
            </div>
        </main>
    </div>

    <script>
        // PWA Installation
        let deferredPrompt;
        const installDialog = document.getElementById('install-dialog');
        const confirmInstall = document.getElementById('confirm-install');
        const cancelInstall = document.getElementById('cancel-install');
        const appLogo = document.getElementById('app-logo');

        // Handle beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Double click logo to show install dialog
        let clickCount = 0;
        let clickTimer;
        
        appLogo.addEventListener('click', () => {
            clickCount++;
            if (clickCount === 1) {
                clickTimer = setTimeout(() => {
                    clickCount = 0;
                }, 300);
            } else if (clickCount === 2) {
                clearTimeout(clickTimer);
                clickCount = 0;
                showInstallDialog();
            }
        });

        function showInstallDialog() {
            if (deferredPrompt) {
                installDialog.classList.add('show');
            } else {
                alert('Installation is already available through your browser\'s menu.');
            }
        }

        confirmInstall.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            }
            installDialog.classList.remove('show');
        });

        cancelInstall.addEventListener('click', () => {
            installDialog.classList.remove('show');
        });

        // Create manifest dynamically
        const manifest = {
            "name": "Dome Album",
            "short_name": "DomeAlbum",
            "description": "Immersive 3D Dome Gallery",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#060010",
            "theme_color": "#060010",
            "orientation": "landscape",
            "icons": [
                {
                    "src": "https://images.unsplash.com/photo-1634942537034-2531766767d1?w=192&h=192&fit=crop&crop=center",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://images.unsplash.com/photo-1634942537034-2531766767d1?w=512&h=512&fit=crop&crop=center",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        // Create and set manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('app-manifest').href = manifestURL;

        // Dome Gallery Implementation
        const DEFAULT_IMAGES = [
            {
                src: 'https://images.unsplash.com/photo-1755331039789-7e5680e26e8f?q=80&w=774&auto=format&fit=crop',
                alt: 'Abstract art'
            },
            {
                src: 'https://images.unsplash.com/photo-1755569309049-98410b94f66d?q=80&w=772&auto=format&fit=crop',
                alt: 'Modern sculpture'
            },
            {
                src: 'https://images.unsplash.com/photo-1755497595318-7e5e3523854f?q=80&w=774&auto=format&fit=crop',
                alt: 'Digital artwork'
            },
            {
                src: 'https://images.unsplash.com/photo-1755353985163-c2a0fe5ac3d8?q=80&w=774&auto=format&fit=crop',
                alt: 'Contemporary art'
            },
            {
                src: 'https://images.unsplash.com/photo-1745965976680-d00be7dc0377?q=80&w=774&auto=format&fit=crop',
                alt: 'Geometric pattern'
            },
            {
                src: 'https://images.unsplash.com/photo-1752588975228-21f44630bb3c?q=80&w=774&auto=format&fit=crop',
                alt: 'Textured surface'
            },
            { 
                src: 'https://images.unsplash.com/photo-1554080353-a576cf803bda?q=80&w=774&auto=format&fit=crop',
                alt: 'Social media image' 
            }
        ];

        const DEFAULTS = {
            maxVerticalRotationDeg: 5,
            dragSensitivity: 20,
            enlargeTransitionMs: 300,
            segments: 35
        };

        class DomeGallery {
            constructor(options = {}) {
                this.options = {
                    images: options.images || DEFAULT_IMAGES,
                    fit: options.fit || 0.5,
                    fitBasis: options.fitBasis || 'auto',
                    minRadius: options.minRadius || 600,
                    maxRadius: options.maxRadius || Infinity,
                    padFactor: options.padFactor || 0.25,
                    overlayBlurColor: options.overlayBlurColor || '#060010',
                    maxVerticalRotationDeg: options.maxVerticalRotationDeg || DEFAULTS.maxVerticalRotationDeg,
                    dragSensitivity: options.dragSensitivity || DEFAULTS.dragSensitivity,
                    enlargeTransitionMs: options.enlargeTransitionMs || DEFAULTS.enlargeTransitionMs,
                    segments: options.segments || DEFAULTS.segments,
                    dragDampening: options.dragDampening || 2,
                    openedImageWidth: options.openedImageWidth || '250px',
                    openedImageHeight: options.openedImageHeight || '350px',
                    imageBorderRadius: options.imageBorderRadius || '30px',
                    openedImageBorderRadius: options.openedImageBorderRadius || '30px',
                    grayscale: options.grayscale !== undefined ? options.grayscale : true
                };

                this.root = document.getElementById('dome-root');
                this.main = document.getElementById('sphere-main');
                this.sphere = document.getElementById('sphere');
                this.viewer = document.getElementById('viewer');
                this.scrim = document.getElementById('scrim');
                this.frame = document.getElementById('frame');
                
                this.rotation = { x: 0, y: 0 };
                this.startRot = { x: 0, y: 0 };
                this.startPos = null;
                this.dragging = false;
                this.moved = false;
                this.inertiaRAF = null;
                this.opening = false;
                this.openStartedAt = 0;
                this.lastDragEndAt = 0;
                this.scrollLocked = false;
                this.focusedEl = null;
                this.originalTilePosition = null;
                this.lockedRadius = null;

                this.items = [];
                
                this.init();
                this.bindEvents();
                this.createItems();
                this.updateOrientation();
            }

            clamp(v, min, max) {
                return Math.min(Math.max(v, min), max);
            }

            normalizeAngle(d) {
                return ((d % 360) + 360) % 360;
            }

            wrapAngleSigned(deg) {
                const a = (((deg + 180) % 360) + 360) % 360;
                return a - 180;
            }

            getDataNumber(el, name, fallback) {
                const attr = el.dataset[name] || el.getAttribute(`data-${name}`);
                const n = attr == null ? NaN : parseFloat(attr);
                return Number.isFinite(n) ? n : fallback;
            }

            buildItems(pool, seg) {
                const xCols = Array.from({ length: seg }, (_, i) => -37 + i * 2);
                const evenYs = [-4, -2, 0, 2, 4];
                const oddYs = [-3, -1, 1, 3, 5];

                const coords = xCols.flatMap((x, c) => {
                    const ys = c % 2 === 0 ? evenYs : oddYs;
                    return ys.map(y => ({ x, y, sizeX: 2, sizeY: 2 }));
                });

                const totalSlots = coords.length;
                if (pool.length === 0) {
                    return coords.map(c => ({ ...c, src: '', alt: '' }));
                }

                const normalizedImages = pool.map(image => {
                    if (typeof image === 'string') {
                        return { src: image, alt: '' };
                    }
                    return { src: image.src || '', alt: image.alt || '' };
                });

                const usedImages = Array.from({ length: totalSlots }, (_, i) => normalizedImages[i % normalizedImages.length]);

                for (let i = 1; i < usedImages.length; i++) {
                    if (usedImages[i].src === usedImages[i - 1].src) {
                        for (let j = i + 1; j < usedImages.length; j++) {
                            if (usedImages[j].src !== usedImages[i].src) {
                                [usedImages[i], usedImages[j]] = [usedImages[j], usedImages[i]];
                                break;
                            }
                        }
                    }
                }

                return coords.map((c, i) => ({
                    ...c,
                    src: usedImages[i].src,
                    alt: usedImages[i].alt
                }));
            }

            computeItemBaseRotation(offsetX, offsetY, sizeX, sizeY, segments) {
                const unit = 360 / segments / 2;
                const rotateY = unit * (offsetX + (sizeX - 1) / 2);
                const rotateX = unit * (offsetY - (sizeY - 1) / 2);
                return { rotateX, rotateY };
            }

            init() {
                this.updateSize();
                this.applyTransform(this.rotation.x, this.rotation.y);
            }

            updateSize() {
                const root = this.root;
                if (!root) return;

                const w = Math.max(1, window.innerWidth);
                const h = Math.max(1, window.innerHeight);
                const minDim = Math.min(w, h);
                const maxDim = Math.max(w, h);
                const aspect = w / h;

                let basis;
                switch (this.options.fitBasis) {
                    case 'min':
                        basis = minDim;
                        break;
                    case 'max':
                        basis = maxDim;
                        break;
                    case 'width':
                        basis = w;
                        break;
                    case 'height':
                        basis = h;
                        break;
                    default:
                        basis = aspect >= 1.3 ? w : minDim;
                }

                let radius = basis * this.options.fit;
                const heightGuard = h * 1.35;
                radius = Math.min(radius, heightGuard);
                radius = this.clamp(radius, this.options.minRadius, this.options.maxRadius);
                this.lockedRadius = Math.round(radius);

                const viewerPad = Math.max(8, Math.round(minDim * this.options.padFactor));
                
                root.style.setProperty('--radius', `${this.lockedRadius}px`);
                root.style.setProperty('--viewer-pad', `${viewerPad}px`);
                root.style.setProperty('--overlay-blur-color', this.options.overlayBlurColor);
                root.style.setProperty('--tile-radius', this.options.imageBorderRadius);
                root.style.setProperty('--enlarge-radius', this.options.openedImageBorderRadius);
                root.style.setProperty('--image-filter', this.options.grayscale ? 'grayscale(1)' : 'none');
                
                this.applyTransform(this.rotation.x, this.rotation.y);
            }

            applyTransform(xDeg, yDeg) {
                if (this.sphere) {
                    this.sphere.style.transform = `translateZ(calc(var(--radius) * -1)) rotateX(${xDeg}deg) rotateY(${yDeg}deg)`;
                }
            }

            createItems() {
                this.items = this.buildItems(this.options.images, this.options.segments);
                
                this.items.forEach((it, i) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.dataset.src = it.src;
                    itemDiv.dataset.offsetX = it.x;
                    itemDiv.dataset.offsetY = it.y;
                    itemDiv.dataset.sizeX = it.sizeX;
                    itemDiv.dataset.sizeY = it.sizeY;
                    
                    itemDiv.style.setProperty('--offset-x', it.x);
                    itemDiv.style.setProperty('--offset-y', it.y);
                    itemDiv.style.setProperty('--item-size-x', it.sizeX);
                    itemDiv.style.setProperty('--item-size-y', it.sizeY);

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'item__image';
                    imageDiv.setAttribute('role', 'button');
                    imageDiv.setAttribute('tabindex', '0');
                    imageDiv.setAttribute('aria-label', it.alt || 'Open image');
                    
                    const img = document.createElement('img');
                    img.src = it.src;
                    img.draggable = false;
                    img.alt = it.alt;
                    
                    imageDiv.appendChild(img);
                    itemDiv.appendChild(imageDiv);
                    this.sphere.appendChild(itemDiv);

                    // Event listeners
                    imageDiv.addEventListener('click', (e) => this.onTileClick(e));
                    imageDiv.addEventListener('pointerup', (e) => this.onTilePointerUp(e));
                });
            }

            bindEvents() {
                // Mouse/touch events
                this.main.addEventListener('mousedown', this.onDragStart.bind(this));
                this.main.addEventListener('touchstart', this.onDragStart.bind(this));
                this.main.addEventListener('mousemove', this.onDrag.bind(this));
                this.main.addEventListener('touchmove', this.onDrag.bind(this));
                this.main.addEventListener('mouseup', this.onDragEnd.bind(this));
                this.main.addEventListener('touchend', this.onDragEnd.bind(this));
                this.main.addEventListener('mouseleave', this.onDragEnd.bind(this));

                // Scrim click for closing
                this.scrim.addEventListener('click', this.closeItem.bind(this));

                // Escape key
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeItem();
                });

                // Resize
                window.addEventListener('resize', () => {
                    this.updateSize();
                    this.updateOrientation();
                });

                // Prevent context menu
                this.main.addEventListener('contextmenu', (e) => e.preventDefault());
            }

            onDragStart(e) {
                if (this.focusedEl) return;
                this.stopInertia();
                this.dragging = true;
                this.moved = false;
                this.startRot = { ...this.rotation };
                
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                this.startPos = { x: clientX, y: clientY };
                e.preventDefault();
            }

            onDrag(e) {
                if (this.focusedEl || !this.dragging || !this.startPos) return;
                
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                const dxTotal = clientX - this.startPos.x;
                const dyTotal = clientY - this.startPos.y;
                
                if (!this.moved) {
                    const dist2 = dxTotal * dxTotal + dyTotal * dyTotal;
                    if (dist2 > 16) this.moved = true;
                }

                const nextX = this.clamp(
                    this.startRot.x - dyTotal / this.options.dragSensitivity,
                    -this.options.maxVerticalRotationDeg,
                    this.options.maxVerticalRotationDeg
                );
                const nextY = this.wrapAngleSigned(this.startRot.y + dxTotal / this.options.dragSensitivity);
                
                if (this.rotation.x !== nextX || this.rotation.y !== nextY) {
                    this.rotation = { x: nextX, y: nextY };
                    this.applyTransform(nextX, nextY);
                }
                
                e.preventDefault();
            }

            onDragEnd(e) {
                if (!this.dragging) return;
                
                this.dragging = false;
                
                if (this.moved) {
                    this.lastDragEndAt = performance.now();
                    
                    // Simple inertia
                    const velocity = 0.5;
                    this.startInertia(velocity, velocity);
                }
                
                this.moved = false;
            }

            onTileClick(e) {
                if (this.dragging) return;
                if (this.moved) return;
                if (performance.now() - this.lastDragEndAt < 80) return;
                if (this.opening) return;
                this.openItemFromElement(e.currentTarget);
            }

            onTilePointerUp(e) {
                if (e.pointerType !== 'touch') return;
                if (this.dragging) return;
                if (this.moved) return;
                if (performance.now() - this.lastDragEndAt < 80) return;
                if (this.opening) return;
                this.openItemFromElement(e.currentTarget);
            }

            stopInertia() {
                if (this.inertiaRAF) {
                    cancelAnimationFrame(this.inertiaRAF);
                    this.inertiaRAF = null;
                }
            }

            startInertia(vx, vy) {
                this.stopInertia();
                
                const MAX_V = 1.4;
                let vX = this.clamp(vx, -MAX_V, MAX_V) * 80;
                let vY = this.clamp(vy, -MAX_V, MAX_V) * 80;
                let frames = 0;
                const d = this.clamp(this.options.dragDampening ?? 0.6, 0, 1);
                const frictionMul = 0.94 + 0.055 * d;
                const stopThreshold = 0.015 - 0.01 * d;
                const maxFrames = Math.round(90 + 270 * d);
                
                const step = () => {
                    vX *= frictionMul;
                    vY *= frictionMul;
                    
                    if (Math.abs(vX) < stopThreshold && Math.abs(vY) < stopThreshold) {
                        this.inertiaRAF = null;
                        return;
                    }
                    
                    if (++frames > maxFrames) {
                        this.inertiaRAF = null;
                        return;
                    }
                    
                    const nextX = this.clamp(
                        this.rotation.x - vY / 200,
                        -this.options.maxVerticalRotationDeg,
                        this.options.maxVerticalRotationDeg
                    );
                    const nextY = this.wrapAngleSigned(this.rotation.y + vX / 200);
                    
                    this.rotation = { x: nextX, y: nextY };
                    this.applyTransform(nextX, nextY);
                    
                    this.inertiaRAF = requestAnimationFrame(step);
                };
                
                this.inertiaRAF = requestAnimationFrame(step);
            }

            lockScroll() {
                if (this.scrollLocked) return;
                this.scrollLocked = true;
                document.body.classList.add('dg-scroll-lock');
            }

            unlockScroll() {
                if (!this.scrollLocked) return;
                if (this.root?.getAttribute('data-enlarging') === 'true') return;
                this.scrollLocked = false;
                document.body.classList.remove('dg-scroll-lock');
            }

            openItemFromElement(el) {
                if (this.opening) return;
                this.opening = true;
                this.openStartedAt = performance.now();
                this.lockScroll();
                
                const parent = el.parentElement;
                this.focusedEl = el;
                el.setAttribute('data-focused', 'true');
                
                const offsetX = this.getDataNumber(parent, 'offsetX', 0);
                const offsetY = this.getDataNumber(parent, 'offsetY', 0);
                const sizeX = this.getDataNumber(parent, 'sizeX', 2);
                const sizeY = this.getDataNumber(parent, 'sizeY', 2);
                
                const parentRot = this.computeItemBaseRotation(offsetX, offsetY, sizeX, sizeY, this.options.segments);
                const parentY = this.normalizeAngle(parentRot.rotateY);
                const globalY = this.normalizeAngle(this.rotation.y);
                
                let rotY = -(parentY + globalY) % 360;
                if (rotY < -180) rotY += 360;
                const rotX = -parentRot.rotateX - this.rotation.x;
                
                parent.style.setProperty('--rot-y-delta', `${rotY}deg`);
                parent.style.setProperty('--rot-x-delta', `${rotX}deg`);
                
                const refDiv = document.createElement('div');
                refDiv.className = 'item__image item__image--reference';
                refDiv.style.opacity = '0';
                refDiv.style.transform = `rotateX(${-parentRot.rotateX}deg) rotateY(${-parentRot.rotateY}deg)`;
                parent.appendChild(refDiv);
                
                // Force reflow
                refDiv.offsetHeight;
                
                const tileR = refDiv.getBoundingClientRect();
                const mainR = this.main.getBoundingClientRect();
                const frameR = this.frame.getBoundingClientRect();
                
                this.originalTilePosition = {
                    left: tileR.left,
                    top: tileR.top,
                    width: tileR.width,
                    height: tileR.height
                };
                
                el.style.visibility = 'hidden';
                el.style.zIndex = '0';
                
                const overlay = document.createElement('div');
                overlay.className = 'enlarge';
                overlay.style.position = 'absolute';
                overlay.style.left = `${frameR.left - mainR.left}px`;
                overlay.style.top = `${frameR.top - mainR.top}px`;
                overlay.style.width = `${frameR.width}px`;
                overlay.style.height = `${frameR.height}px`;
                overlay.style.opacity = '0';
                overlay.style.zIndex = '30';
                overlay.style.willChange = 'transform, opacity';
                overlay.style.transformOrigin = 'top left';
                overlay.style.transition = `transform ${this.options.enlargeTransitionMs}ms ease, opacity ${this.options.enlargeTransitionMs}ms ease`;
                
                const rawSrc = parent.dataset.src || el.querySelector('img')?.src || '';
                const img = document.createElement('img');
                img.src = rawSrc;
                overlay.appendChild(img);
                this.viewer.appendChild(overlay);
                
                const tx0 = tileR.left - frameR.left;
                const ty0 = tileR.top - frameR.top;
                const sx0 = tileR.width / frameR.width;
                const sy0 = tileR.height / frameR.height;
                
                const validSx0 = isFinite(sx0) && sx0 > 0 ? sx0 : 1;
                const validSy0 = isFinite(sy0) && sy0 > 0 ? sy0 : 1;
                
                overlay.style.transform = `translate(${tx0}px, ${ty0}px) scale(${validSx0}, ${validSy0})`;
                
                setTimeout(() => {
                    if (!overlay.parentElement) return;
                    overlay.style.opacity = '1';
                    overlay.style.transform = 'translate(0px, 0px) scale(1, 1)';
                    this.root.setAttribute('data-enlarging', 'true');
                }, 16);
                
                this.opening = false;
            }

            closeItem() {
                if (performance.now() - this.openStartedAt < 250) return;
                if (!this.focusedEl) return;
                
                const el = this.focusedEl;
                const parent = el.parentElement;
                const overlay = this.viewer.querySelector('.enlarge');
                
                if (!overlay) return;
                
                const originalPos = this.originalTilePosition;
                if (!originalPos) {
                    overlay.remove();
                    parent.style.setProperty('--rot-y-delta', '0deg');
                    parent.style.setProperty('--rot-x-delta', '0deg');
                    el.style.visibility = '';
                    el.style.zIndex = '0';
                    this.focusedEl = null;
                    this.root.removeAttribute('data-enlarging');
                    this.unlockScroll();
                    return;
                }
                
                const currentRect = overlay.getBoundingClientRect();
                const rootRect = this.root.getBoundingClientRect();
                
                const animatingOverlay = document.createElement('div');
                animatingOverlay.className = 'enlarge-closing';
                animatingOverlay.style.cssText = `
                    position: absolute;
                    left: ${currentRect.left - rootRect.left}px;
                    top: ${currentRect.top - rootRect.top}px;
                    width: ${currentRect.width}px;
                    height: ${currentRect.height}px;
                    z-index: 9999;
                    border-radius: var(--enlarge-radius, 32px);
                    overflow: hidden;
                    box-shadow: 0 10px 30px rgba(0,0,0,.35);
                    transition: all ${this.options.enlargeTransitionMs}ms ease-out;
                    pointer-events: none;
                `;
                
                const originalImg = overlay.querySelector('img');
                if (originalImg) {
                    const img = originalImg.cloneNode();
                    img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                    animatingOverlay.appendChild(img);
                }
                
                overlay.remove();
                this.root.appendChild(animatingOverlay);
                
                void animatingOverlay.getBoundingClientRect();
                
                requestAnimationFrame(() => {
                    animatingOverlay.style.left = `${originalPos.left - rootRect.left}px`;
                    animatingOverlay.style.top = `${originalPos.top - rootRect.top}px`;
                    animatingOverlay.style.width = `${originalPos.width}px`;
                    animatingOverlay.style.height = `${originalPos.height}px`;
                    animatingOverlay.style.opacity = '0';
                });
                
                const cleanup = () => {
                    animatingOverlay.remove();
                    this.originalTilePosition = null;
                    
                    parent.style.transition = 'none';
                    el.style.transition = 'none';
                    parent.style.setProperty('--rot-y-delta', '0deg');
                    parent.style.setProperty('--rot-x-delta', '0deg');
                    
                    requestAnimationFrame(() => {
                        el.style.visibility = '';
                        el.style.opacity = '0';
                        el.style.zIndex = '0';
                        this.focusedEl = null;
                        this.root.removeAttribute('data-enlarging');
                        
                        requestAnimationFrame(() => {
                            parent.style.transition = '';
                            el.style.transition = 'opacity 300ms ease-out';
                            
                            requestAnimationFrame(() => {
                                el.style.opacity = '1';
                                setTimeout(() => {
                                    el.style.transition = '';
                                    el.style.opacity = '';
                                    if (!this.dragging && this.root?.getAttribute('data-enlarging') !== 'true') {
                                        document.body.classList.remove('dg-scroll-lock');
                                    }
                                }, 300);
                            });
                        });
                    });
                };
                
                animatingOverlay.addEventListener('transitionend', cleanup, { once: true });
            }

            updateOrientation() {
                const isMobile = window.innerWidth <= 768;
                const isPortrait = window.innerHeight > window.innerWidth;
                const landscapeWarning = document.getElementById('landscape-warning');
                
                if (isMobile && isPortrait) {
                    // Show landscape warning
                    landscapeWarning.classList.add('show');
                    document.body.classList.remove('force-landscape');
                } else {
                    // Hide warning and apply rotation if needed
                    landscapeWarning.classList.remove('show');
                    
                    if (isMobile) {
                        // Force landscape mode on mobile
                        document.body.classList.add('force-landscape');
                    } else {
                        // Desktop/Tablet - no rotation needed
                        document.body.classList.remove('force-landscape');
                    }
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Dome Gallery
            const domeGallery = new DomeGallery({
                images: DEFAULT_IMAGES,
                fit: 0.5,
                fitBasis: 'auto',
                minRadius: 400,
                maxRadius: 800,
                padFactor: 0.25,
                overlayBlurColor: '#060010',
                maxVerticalRotationDeg: 5,
                dragSensitivity: 20,
                enlargeTransitionMs: 300,
                segments: 35,
                dragDampening: 2,
                openedImageWidth: '250px',
                openedImageHeight: '350px',
                imageBorderRadius: '30px',
                openedImageBorderRadius: '30px',
                grayscale: true
            });

            // Update orientation on load
            domeGallery.updateOrientation();

            // Service Worker registration for PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
                });
            }

            // Prevent default touch actions
            document.addEventListener('touchmove', (e) => {
                if (e.scale !== 1) e.preventDefault();
            }, { passive: false });

            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                const domeGallery = window.domeGallery;
                if (domeGallery) {
                    domeGallery.updateSize();
                    domeGallery.updateOrientation();
                }
            }, 100);
        });

        // Make domeGallery globally accessible
        window.domeGallery = null;
    </script>
</body>
</html>